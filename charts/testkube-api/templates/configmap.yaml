apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "testkube-api.fullname" . }}
  labels: {{- include "testkube-api.labels" . | nindent 4 }}
    {{- if .Values.global.labels }}
    {{- include "global.tplvalues.render" ( dict "value" .Values.global.labels "context" $ ) | nindent 4 }}
    {{- end }}
  {{- if .Values.global.annotations}}
  annotations: {{- include "global.tplvalues.render" ( dict "value" .Values.global.annotations "context" $ ) | nindent 4 }}
  {{- end }}
data:
  executors.json: |-
{{ .Files.Get "executors.json" | indent 4 }}
  job-container-template.yml: |-
{{ .Files.Get "job-container-template.yml.tmpl" | indent 4 }}
  job-scraper-template.yml: |-
{{ .Files.Get "job-scraper-template.yml.tmpl" | indent 4 }}
  job-template.yml: |-
{{- if .Values.configValues }}
  {{ toYaml .Values.configValues | trimAll "|" | trim | indent 4 }}
{{- else }}
    apiVersion: batch/v1
    kind: Job
    metadata:
      name: {{ printf "\"{{ .Name }}\"" }}
      namespace: {{ printf "{{ .Namespace }}" }}
      {{- if .Values.templates.labels }}
      labels:
      {{- include "global.tplvalues.render" ( dict "value" .Values.templates.labels "context" $ ) | nindent 8 }}
      {{- end }}
      {{- if .Values.templates.annotations }}
      annotations:
      {{- include "global.tplvalues.render" ( dict "value" .Values.templates.annotations "context" $ ) | nindent 8 }}
      {{- end }}
{{ .Files.Get "job-template-spec.yml.tmpl" | indent 4 }}
{{- end }}
  pvc-template.yml: |-
{{ .Files.Get "pvc-template.yml.tmpl" | indent 4 }}
  slack-config.json: |-
{{- if .Values.slackConfig }}
  {{ toJson .Values.slackConfig | indent 4 }}
{{- else }}
{{ .Files.Get "slack-config.json" | indent 4 }}
{{- end }}
  slack-template.json: |-
{{ .Files.Get "slack-template.json.tmpl" | indent 4 }}
  slave-pod-template.yml: |-
{{ .Files.Get "slave-pod-template.yml.tmpl" | indent 4 }}
{{- $executors := "" }}
{{- range $k, $v := .Values.enabledExecutors }}
  {{- if $v.enabled }}
    {{- $executors = print $executors "," $k }}
  {{- end }}
{{- end }}
  enabledExecutors: "{{ $executors }}"
